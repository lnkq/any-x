<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Any-X — Simple WebSocket Chat</title>
    <style>
        :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
        body{margin:0;display:flex;flex-direction:column;height:100vh}
        header{padding:12px 16px;background:#0b5fff;color:#fff}
        main{flex:1;display:flex;gap:12px;padding:12px}
        #messages{flex:1;border:1px solid #ddd;border-radius:6px;padding:12px;overflow:auto;background:#fafafa}
        #messages .msg{margin-bottom:8px;padding:8px;border-radius:6px;background:#fff;border:1px solid #eee;transition:transform 220ms cubic-bezier(.2,.9,.2,1),opacity 200ms ease;transform-origin:top-left}
        #messages .msg.enter{transform:translateY(-12px);opacity:0}
        #messages .meta{font-size:12px;color:#666;margin-bottom:6px}
        .controls{width:360px;display:flex;flex-direction:column;gap:8px}
        .input-row{display:flex;gap:8px}
        input[type="text"]{flex:1;padding:8px;border:1px solid #ccc;border-radius:6px}
        button{padding:8px 12px;border:none;border-radius:6px;background:#0b5fff;color:#fff;cursor:pointer}
        button:disabled{opacity:.6;cursor:not-allowed}
        footer{padding:8px 12px;background:#f3f4f6;font-size:13px;color:#333}
    </style>
</head>
<body>
    <header>
        <strong>Any-X</strong> — WebSocket chat (connects to <code>ws://localhost:8080/ws</code>)
    </header>

    <main>
        <section id="messages" aria-live="polite"></section>

        <aside class="controls">
            <div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                    <span id="status">Status: <strong>disconnected</strong></span>
                </div>
                <div class="input-row">
                    <input id="textInput" type="text" placeholder="Write a message..." autocomplete="off" />
                    <button id="sendBtn">Send</button>
                </div>
            </div>
            <div style="font-size:13px;color:#666">
                Messages received from server will appear on the left.
            </div>
        </aside>
    </main>

    <footer>
        Tip: press Enter to send. The client will try to reconnect if the socket closes.
    </footer>

    <script>
        (function(){
            const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.hostname + ':8080/ws';
            const messagesEl = document.getElementById('messages');
            const input = document.getElementById('textInput');
            const sendBtn = document.getElementById('sendBtn');
            const statusEl = document.getElementById('status');

            let ws = null;
            let reconnectTimer = null;

            function setStatus(text, cls){
                statusEl.innerHTML = 'Status: <strong>' + text + '</strong>';
            }

                        function appendMessage(text, meta){
                                const wrapper = document.createElement('div');
                                wrapper.className = 'msg enter';
                                if(meta){
                                        const m = document.createElement('div');
                                        m.className = 'meta';
                                        m.textContent = meta;
                                        wrapper.appendChild(m);
                                }
                                const b = document.createElement('div');
                                b.textContent = text;
                                wrapper.appendChild(b);

                                // Insert at top so newest messages appear first
                                messagesEl.insertBefore(wrapper, messagesEl.firstChild);

                                // Trigger enter -> normal transition
                                // Force reflow then remove the 'enter' class so CSS transition runs
                                void wrapper.getBoundingClientRect();
                                wrapper.classList.remove('enter');

                                // Keep view focused at top (smooth)
                                try{
                                    messagesEl.scrollTo({ top: 0, behavior: 'smooth' });
                                }catch(e){
                                    messagesEl.scrollTop = 0;
                                }
                        }

            function connect(){
                if(ws) ws.close();
                setStatus('connecting');
                try{
                    ws = new WebSocket(WS_URL);
                }catch(e){
                    setStatus('error');
                    scheduleReconnect();
                    return;
                }

                ws.addEventListener('open', () => {
                    setStatus('connected');
                    if(reconnectTimer){ clearTimeout(reconnectTimer); reconnectTimer = null; }
                });

                ws.addEventListener('message', (ev) => {
                    const now = new Date().toLocaleTimeString();
                    appendMessage(ev.data, now);
                });

                ws.addEventListener('close', () => {
                    setStatus('disconnected');
                    scheduleReconnect();
                });

                ws.addEventListener('error', (ev) => {
                    setStatus('error');
                });
            }

            function scheduleReconnect(){
                if(reconnectTimer) return;
                reconnectTimer = setTimeout(()=>{
                    reconnectTimer = null; connect();
                }, 1500);
            }

            function send(){
                const v = input.value.trim();
                if(!v) return;
                if(!ws || ws.readyState !== WebSocket.OPEN){
                    appendMessage('Cannot send — not connected', new Date().toLocaleTimeString());
                    return;
                }
                ws.send(v);
                const now = new Date().toLocaleTimeString();
                appendMessage(v, now + ' (you)');
                input.value = '';
                input.focus();
            }

            sendBtn.addEventListener('click', send);
            input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ e.preventDefault(); send(); } });

            // start
            connect();
        })();
    </script>
</body>
</html>